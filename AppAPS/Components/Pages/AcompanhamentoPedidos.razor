@page "/acompanhamentoPedidos/"
@using AppAPS.DTOs
@using AppAPS.Entities
@using AppAPS.Interfaces
@using AppAPS.Services.Model
@using AutoMapper
@inject IDialogService DialogService
@rendermode RenderMode.InteractiveServer

<style>
    .fluent-label {
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 2;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .fluent-label-nome {
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 1;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .text-field {
        width: 100%;
    }

    .width-maximo {
        width: 100%;
    }

    .fluent-wizard-buttons {
        display: none !important;
    }

    .custom-botao {
        height: 70px;
        padding: 5px;
        border-radius: 7px;
        gap: 0;
    }

    .cor-botao-confirmado{
        background-color: palevioletred;
    }

    .cor-botao-em-preparo {
        background-color: coral;
    }

    .custom-botao:hover {
        opacity: 0.5;
    }

    .disabled-stack {
        pointer-events: none; /* Desabilita todas as interações */
        opacity: 0.7; /* Reduz a opacidade para indicar que está desabilitado */
    }

</style>

<PageTitle>Acompanhamento pedidos</PageTitle>

<FluentStack HorizontalAlignment="HorizontalAlignment.Center">
    <FluentCard Width="80%" Height="90%" Style="display: flex; flex-wrap: wrap; gap: 10px;">
        <FluentStack HorizontalAlignment="HorizontalAlignment.Center" Style="max-height: 85vh; overflow-y: auto">
            <FluentStack Width="100%" Style="display: flex; flex-wrap: wrap; gap: 10px;">
                @{
                    if (Pedidos != null && Pedidos.Any())
                    {
                        foreach (Pedido pedido in Pedidos)
                        {
                            <FluentStack Style="display:flex; flex-direction: row;">
                                <FluentStack Width="100%" Style="height 10vh;">
                                    <FluentStack Style="display:flex; flex-direction: column; gap: 2; max-width: 15vw">
                                        <FluentLabel Typo="Typography.H2" Color="Color.Accent" Class="fluent-label-nome">Cód: @pedido.Id</FluentLabel>
                                        <FluentLabel Typo="Typography.H3" Class="fluent-label-nome">@pedido.Cliente</FluentLabel>
                                        <FluentButton Color="white" BackgroundColor="@DefineCorStatus(pedido.Status)" Stye="pointer-events: none;">
                                            <FluentLabel Color="Color.Lightweight" Typo="Typography.Subject" Class="fluent-label-nome">@EnumHelper.GetEnumDescription(pedido.Status)</FluentLabel>
                                        </FluentButton>
                                        <FluentLabel Typo="Typography.Body" Class="fluent-label">@pedido.DataAbertura.ToString("dd/MM HH:mm")</FluentLabel>
                                    </FluentStack>

                                    <FluentStack Style="display:flex; flex-direction: column; gap: 1; max-width: 15vw;">
                                        <FluentLabel Typo="Typography.Subject" Class="fluent-label-nome">@pedido.Rua</FluentLabel>
                                        <FluentLabel Typo="Typography.Body" Class="fluent-label-nome">@EnumHelper.GetEnumDescription(pedido.Bairro)</FluentLabel>
                                        <FluentLabel Typo="Typography.Subject" Class="fluent-label-nome">@EnumHelper.GetEnumDescription(pedido.FormaEntrega)</FluentLabel>
                                        <FluentLabel Typo="Typography.Subject" Class="fluent-label-nome">@EnumHelper.GetEnumDescription(pedido.FormaPagamento)</FluentLabel>
                                    </FluentStack>
                                    <FluentStack VerticalAlignment="VerticalAlignment.Center">
                                        <FluentStack @onclick="() => HandleClick(pedido, StatusPedido.Confirmado)" Class="@(DesabilitaBotaoConfirmado ? "disabled-stack custom-botao cor-botao-confirmado" : "custom-botao cor-botao-confirmado")" Style="display: flex; flex-direction: column; align-items: center;" Width="90px">
                                            <FluentIcon Color="Color.Lightweight" Width="30px" Value="@(new Icons.Filled.Size24.AlertOn())"></FluentIcon>
                                            <FluentLabel Color="Color.Lightweight">Confirmado</FluentLabel>
                                        </FluentStack>

                                        <FluentDivider Orientation="Orientation.Horizontal" Style="height: 2px; width: 20px; background-color: lightgray;" />
                                        <FluentIcon Value="@(new Icons.Filled.Size24.Checkmark())"></FluentIcon>
                                        <FluentDivider Orientation="Orientation.Horizontal" Style="height: 2px; width: 20px; background-color: lightgray;" />

                                        <FluentStack @onclick="() => HandleClick(pedido, StatusPedido.EmPreparo)" Class="custom-botao cor-botao-em-preparo" Style="display: flex; flex-direction: column; align-items: center;" Width="90px">
                                            <FluentIcon Color="Color.Lightweight" Width="30px" Value="@(new Icons.Filled.Size24.FoodPizza())"></FluentIcon>
                                            <FluentLabel Color="Color.Lightweight">Em preparo</FluentLabel>
                                        </FluentStack>
                                    </FluentStack>
                                </FluentStack>
                            </FluentStack>
                            <FluentDivider Style="background-color: black; width: 100%; height: 2px" />
                        }
                    }
                    else
                    {
                        <FluentLabel Typo="Typography.H2">Não há registros cadastrados.</FluentLabel>
                    }
                }
            </FluentStack>
        </FluentStack>
    </FluentCard>
</FluentStack>


@code {
    [Inject] private SessaoUsuario sessaoUsuario { get; set; }
    public List<Pedido> Pedidos = new();
    public List<ProdutoItemDTO> produtosItens = new();
    public decimal Numero { get; set; }
    public int IdProduto { get; set; }
    public decimal TotalPedido { get; set; }
    private int pedidoStatusInt;
    private bool DesabilitaBotaoConfirmado;
    WizardStepSequence StepSequence = WizardStepSequence.Any;

    protected async override Task OnInitializedAsync()
    {
        Pedidos = sessaoUsuario.Pedidos;
    }

    private void OnQuantidadeChanged(int novaQuantidade, ProdutoItemDTO produtoItem)
    {
        produtoItem.Quantidade = novaQuantidade;
        produtoItem.ValorTotal = novaQuantidade * produtoItem.Preco;
        AtualizaTotal();
    }

    public string DefineCorStatus(StatusPedido status)
    {
        switch (status)
        {
            case StatusPedido.Confirmado:
                return "palevioletred";
            case StatusPedido.EmPreparo:
                return "coral";
            case StatusPedido.ProntoParaEntrega:
                return "lightyellow";
            case StatusPedido.EmTransito:
                return "blue";
            case StatusPedido.Finalizado:
                return "lightgreen";
            default:
                return "";
        }
    }

    private void HandleClick(Pedido pedido, StatusPedido novoStatus)
    {
        pedido.Status = novoStatus;
        AtualizaLayoutStatus(novoStatus);
    }

    private void AtualizaLayoutStatus(StatusPedido statusAtual)
    {
        switch (statusAtual)
        {
            case StatusPedido.Confirmado:
                break;
            case StatusPedido.EmPreparo:
                DesabilitaBotaoConfirmado = true;
                break;
        }
    }

    private void AtualizaTotal()
    {
        produtosItens.ToList().ForEach(item => TotalPedido += item.ValorTotal);
    }

    private Task OnChangedStep(Pedido pedido, int selectedValue)
    {
        pedido.Status = (StatusPedido)selectedValue;
        return Task.CompletedTask;
    }


    async Task OnFinishedAsync()
    {
        await DialogService.ShowSuccessAsync("O pedido {numeroPedido} foi finalizado", "Pedido finalizado.");
    }
}
